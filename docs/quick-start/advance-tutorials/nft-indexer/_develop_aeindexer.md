## Step 3 - Develop NFT AeIndexer

### Download the Development Template

1. Go to the AeIndexer details page for your created project.
2. Download the development template by entering your project name.
   ![download-template](/img/download-nft-indexer-template.png)
3. Unzip the downloaded file to extract the project files.
4. After unzipping the files, you are ready to start development

### Project Structure

import FileTree from '@theme/FileTree';

The initial version of the NFT AeIndexer project has the following structure:

export const initialProjectTree = {
"type": "directory",
"uri": "NFTAeIndexer",
"expanded": true,
"children": [
{
"type": "directory",
"uri": "Contracts",
"expanded": true,
"children": [
{
"type": "file",
"uri" : "MyContract.c.cs"
},
{
"type": "file",
"uri" : "MyContract.g.cs"
},
]
},
{
"type": "directory",
"uri": "Entities",
"expanded": true,
"children": [
{
"type": "file",
"uri" : "MyEntity.cs"
},
]
},
{
"type": "directory",
"uri": "Processors",
"expanded": true,
"children": [
{
"type": "file",
"uri" : "MyLogEventProcessor.cs"
},
]
},
{
"type": "directory",
"uri": "GraphQL",
"expanded": true,
},
]
}

<div style={{height: 300}}><FileTree tree={initialProjectTree} /></div>

To ensure the project is set up correctly, follow these steps:

### Setting Up the Files for NFT AeIndexer

1. **Rename Files in the `Contracts/` Folder:**

   - Navigate to the `Contracts/` folder inside your project.
   - Rename `MyContract.c.cs` to `TokenContract.c.cs`.
   - Rename `MyContract.g.cs` to `TokenContract.g.cs`.

2. **Download Token Contract Files:**

   - Go to the [AeFinder GitHub NFT AeIndexer sample](https://github.com/AeFinderProject/aefinder/tree/master/samples/TokenAeIndexer).
   - Locate and download the token contract files.

3. **Copy and Replace Code:**

   - Open the downloaded token contract files.
   - Copy the content from `TokenContract.c.cs` and `TokenContract.g.cs`.
   - Paste the copied code into the corresponding files in the `src/NFTAeIndexer/Contracts` directory of your project:
     - Paste into `TokenContract.c.cs`.
     - Paste into `TokenContract.g.cs`.

4. **Rename and add new files in the `Entities/` Folder:**

   - Navigate to the `Entities/` folder inside your project.
   - Rename `MyEntity.cs` to `Account.cs`.
   - Add new `TransferRecord.cs` file inside `Entities` folder.

5. **Rename and add new files in the `Processors/` Folder:**
   - Navigate to the `Processors/` folder inside your project.
   - Rename `MyLogEventProcessor.cs` to `NFTTransferredProcessor.cs`.

### Updated Project Structure

After the setup, your NFT AeIndexer project will have the following structure:

export const finalProjectTree = {
"type": "directory",
"uri": "NFTAeIndexer",
"expanded": true,
"children": [
{
"type": "directory",
"uri": "Contracts",
"expanded": true,
"children": [
{
"type": "file",
"uri" : "TokenContract.c.cs"
},
{
"type": "file",
"uri" : "TokenContract.g.cs"
},
]
},
{
"type": "directory",
"uri": "Entities",
"expanded": true,
"children": [
{
"type": "file",
"uri" : "Account.cs"
},
{
"type": "file",
"uri" : "TransferRecord.cs"
},
]
},
{
"type": "directory",
"uri": "Processors",
"expanded": true,
"children": [
{
"type": "file",
"uri" : "NFTTransferredProcessor.cs",
},
]
},
{
"type": "directory",
"uri": "GraphQL",
"expanded": true,
},
]
}

<div style={{height: 320}}><FileTree tree={finalProjectTree} /></div>

:::tip
ℹ️ Note: If other contract files are needed, they need to be generated by compiling the corresponding contract project!
:::

#### 1. Entity Models

- Navigate to the `Entities/` folder inside your project.

- `Account.cs` file is as follows:

```csharp title="Account.cs"
using AeFinder.Sdk.Entities;
using Nest;

namespace NFTAeIndexer.Entities;

public class Account: AeFinderEntity, IAeFinderEntity
{
    [Keyword] public string Address { get; set; }
    [Keyword] public string Symbol { get; set; }
    public long Amount { get; set; }
    public string TokenName { get; set; }
    public string NftImageUri { get; set; }
    public string NftAttributes { get; set; }
}
```

- **`TransferRecord.cs`** file is as follows:

```csharp title="TransferRecord.cs"
using AeFinder.Sdk.Entities;
using Nest;

namespace NFTAeIndexer.Entities;

public class TransferRecord: AeFinderEntity, IAeFinderEntity
{
    [Keyword] public string Symbol { get; set; }
    [Keyword] public string ToAddress { get; set; }
    public long Amount { get; set; }
    [Text] public string Memo { get; set; }
}
```

#### 2. NFT Transfer Processor

The NFTTransferredProcessor handles NFT transfer events and updates account balances:

- Navigate to the `Processors/` folder inside your project.

- `NFTTransferredProcessor.cs` file is as follows:

```csharp title="NFTTransferredProcessor.cs"
using Microsoft.Extensions.Logging;
using AElf.Contracts.MultiToken;
using AeFinder.Sdk.Logging;
using AeFinder.Sdk.Processor;
using AeFinder.Sdk;
using NFTAeIndexer.Entities;
using Volo.Abp.DependencyInjection;

namespace NFTAeIndexer.Processors;

public class NFTTransferredProcessor : LogEventProcessorBase<Issued>, ITransientDependency
{
    private readonly IBlockChainService _blockChainService;

    public NFTTransferredProcessor(IBlockChainService blockChainService)
    {
        _blockChainService = blockChainService;
    }

    public override string GetContractAddress(string chainId)
    {
        return chainId switch
        {
            "AELF" => "JRmBduh4nXWi1aXgdUsj5gJrzeZb2LxmrAbf7W99faZSvoAaE",
            "tDVW" => "ASh2Wt7nSEmYqnGxPPzp4pnVDU4uhj1XW9Se5VeZcX2UDdyjx",
            _ => string.Empty
        };
    }

    public override async Task ProcessAsync(Issued logEvent, LogEventContext context)
    {
        if (!IsNftTransfer(logEvent))
        {
            return;
        }

        var tokenInfoParam = new GetTokenInfoInput
        {
            Symbol = logEvent.Symbol
        };

        var nftTransfer = new TransferRecord
        {
            Id = $"{context.ChainId}-{context.Transaction.TransactionId}-{context.LogEvent.Index}",
            ToAddress = logEvent.To.ToBase58(),
            Symbol = logEvent.Symbol,
            Amount = logEvent.Amount,
            Memo = logEvent.Memo
        };
        await SaveEntityAsync(nftTransfer);

        await ChangeNFTBalanceAsync(context.ChainId, logEvent.To.ToBase58(), logEvent.Symbol, logEvent.Amount);
    }

    private async Task ChangeNFTBalanceAsync(string chainId, string address, string symbol, long amount)
    {
        var accountId = $"{chainId}-{address}-{symbol}";
        var account = await GetEntityAsync<Account>(accountId);
        var tokenInfoParam = new GetTokenInfoInput { Symbol = symbol };
        var contractAddress = GetContractAddress(chainId);
        var tokenInfo = await _blockChainService.ViewContractAsync<TokenInfo>(
            chainId, contractAddress,
            "GetTokenInfo", tokenInfoParam);

        Logger.LogDebug("TokenInfo response: {@TokenInfo}", tokenInfo);

        if (account == null)
        {
            account = new Account
            {
                Id = accountId,
                Symbol = symbol,
                Amount = amount,
                Address = address,
                TokenName = tokenInfo.TokenName,
                NftImageUri = tokenInfo.ExternalInfo?.Value["__nft_image_uri"] ?? tokenInfo.ExternalInfo?.Value["__nft_image_url"],
                NftAttributes = tokenInfo.ExternalInfo?.Value["__nft_attributes"]
            };
        }
        else
        {
            account.Amount += amount;
        }

        Logger.LogDebug("NFT Balance changed: {0} {1} {2} {3}", account.Address, account.Symbol, account.Amount, account.TokenName);

        await SaveEntityAsync(account);
    }

    private bool IsNftTransfer(Issued logEvent)
    {
        return !string.IsNullOrEmpty(logEvent.Symbol) && logEvent.Symbol.Contains("-") &&
            logEvent.Amount > 0 &&
            logEvent.To != null && !string.IsNullOrEmpty(logEvent.To.ToBase58());
    }
}
```

- Add files `AccountDto.cs`, `TransferRecordDto.cs`, `GetAccountInput.cs`, `GetTransferRecordInput.cs` to the directory `src/NFTAeIndexer/GraphQL`.

```csharp title="AccountDto.cs"
using AeFinder.Sdk.Dtos;

namespace NFTAeIndexer.GraphQL;

public class AccountDto : AeFinderEntityDto
{
    public string Address { get; set; }
    public string Symbol { get; set; }
    public long Amount { get; set; }
    public string TokenName { get; set; }
    public string NftImageUri { get; set; }
    public string NftAttributes { get; set; }
}
```

```csharp title="TransferRecordDto.cs"
using AeFinder.Sdk.Dtos;

namespace NFTAeIndexer.GraphQL;

public class TransferRecordDto : AeFinderEntityDto
{
    public string Symbol { get; set; }
    public string FromAddress { get; set; }
    public string ToAddress { get; set; }
    public long Amount { get; set; }
}
```

```csharp title="GetAccountInput.cs"
namespace NFTAeIndexer.GraphQL;

public class GetAccountInput
{
    public string ChainId { get; set; }
    public string Address { get; set; }
    public string Symbol { get; set; }
}
```

```csharp title="GetTransferRecordInput.cs"
namespace NFTAeIndexer.GraphQL;

public class GetTransferRecordInput
{
    public string ChainId { get; set; }
    public string Address { get; set; }
    public string Symbol { get; set; }
}
```

- Modify `src/NFTAeIndexer/GraphQL/Query.cs` to add query logic.

```csharp title="Query.cs"
using AeFinder.Sdk;
using GraphQL;
using NFTAeIndexer.Entities;
using Volo.Abp.ObjectMapping;

namespace NFTAeIndexer.GraphQL;

public class Query
{
    public static async Task<List<AccountDto>> Account(
        [FromServices] IReadOnlyRepository<Account> repository,
        [FromServices] IObjectMapper objectMapper,
        GetAccountInput input)
    {
        var queryable = await repository.GetQueryableAsync();

        queryable = queryable.Where(a => a.Metadata.ChainId == input.ChainId);

        if (!input.Address.IsNullOrWhiteSpace())
        {
            queryable = queryable.Where(a => a.Address == input.Address);
        }

        if (!input.Symbol.IsNullOrWhiteSpace())
        {
            queryable = queryable.Where(a => a.Symbol == input.Symbol && a.Symbol.Contains("-"));
        }

        var accounts = queryable.OrderBy(o => o.Metadata.Block.BlockHeight).ToList();

        return objectMapper.Map<List<Account>, List<AccountDto>>(accounts);
    }

    public static async Task<List<TransferRecordDto>> TransferRecord(
        [FromServices] IReadOnlyRepository<TransferRecord> repository,
        [FromServices] IObjectMapper objectMapper,
        GetTransferRecordInput input)
    {
        var queryable = await repository.GetQueryableAsync();

        queryable = queryable.Where(a => a.Metadata.ChainId == input.ChainId);

        if (!input.Address.IsNullOrWhiteSpace())
        {
            queryable = queryable.Where(a => a.ToAddress == input.Address);
        }

        // Filter by Symbol, ensuring it matches the NFT pattern
        if (!input.Symbol.IsNullOrWhiteSpace())
        {
            queryable = queryable.Where(a => a.Symbol == input.Symbol && a.Symbol.Contains("-"));
        }

        // Ensure NFT-specific conditions
        queryable = queryable.Where(a => a.Symbol.Contains("-") && a.Amount > 0);

        var transferRecords = queryable.OrderBy(o => o.Metadata.Block.BlockHeight).ToList();

        return objectMapper.Map<List<TransferRecord>, List<TransferRecordDto>>(transferRecords);
    }
}
```

- Register log event processor

  Modify `src/NFTAeIndexer/NFTAeIndexerModule.cs` to register NFTTransferredProcessor.

```csharp title="NFTAeIndexerModule.cs"
using AeFinder.Sdk.Processor;
using NFTAeIndexer.GraphQL;
using NFTAeIndexer.Processors;
using GraphQL.Types;
using Microsoft.Extensions.DependencyInjection;
using Volo.Abp.AutoMapper;
using Volo.Abp.Modularity;

namespace NFTAeIndexer;

public class NFTAeIndexerModule: AbpModule
{
    public override void ConfigureServices(ServiceConfigurationContext context)
    {
        Configure<AbpAutoMapperOptions>(options => { options.AddMaps<NFTAeIndexerModule>(); });
        context.Services.AddSingleton<ISchema, AeIndexerSchema>();

        // Add your LogEventProcessor implementation.
        context.Services.AddSingleton<ILogEventProcessor, NFTTransferredProcessor>();
    }
}
```

- Add entity mapping

  Modify `src/NFTAeIndexer/NFTAeIndexerAutoMapperProfile.cs` and add entity mapping code.

```csharp title="NFTAeIndexerAutoMapperProfile.cs"
using NFTAeIndexer.Entities;
using NFTAeIndexer.GraphQL;
using AutoMapper;

namespace NFTAeIndexer;

public class NFTAeIndexerAutoMapperProfile : Profile
{
    public NFTAeIndexerAutoMapperProfile()
    {
        CreateMap<Account, AccountDto>();
        CreateMap<TransferRecord, TransferRecordDto>();
    }
}
```

### Building code

Use the following command in the code directory to compile the code.

```bash
dotnet build -c Release
```
